{"version":3,"file":"window-functions.js","sources":["../../../../../../node_modules/arquero/src/op/window-functions.js"],"sourcesContent":["import error from '../util/error';\nimport isValid from '../util/is-valid';\nimport noop from '../util/no-op';\nimport NULL from '../util/null';\n\n/**\n * Initialize a window operator.\n * @callback WindowInit\n * @return {void}\n */\n\n/**\n * A storage object for the state of the window.\n * @typedef {import('../engine/window/window-state').default} WindowState\n */\n\n/**\n * Retrieve an output value from a window operator.\n * @callback WindowValue\n * @param {WindowState} state The window state object.\n * @return {*} The output value.\n */\n\n/**\n * Initialize an aggregate operator.\n * @typedef {import('./aggregate-functions').AggregateInit} AggregateInit\n */\n\n/**\n * Retrive an output value from an aggregate operator.\n * @typedef {import('./aggregate-functions').AggregateValue} AggregateValue\n */\n\n/**\n * An operator instance for a window function.\n * @typedef {object} WindowOperator\n * @property {AggregateInit} init Initialize the operator.\n * @property {AggregateValue} value Retrieve an output value.\n */\n\n/**\n * Create a new window operator instance.\n * @callback WindowCreate\n * @param {...any} params The aggregate operator parameters.\n * @return {WindowOperator} The instantiated window operator.\n */\n\n/**\n * Create a new aggregate operator instance.\n * @typedef {import('./aggregate-functions').AggregateCreate} AggregateCreate\n */\n\n/**\n * An operator definition for a window function.\n * @typedef {object} WindowDef\n * @property {AggregateCreate} create Create a new operator instance.\n * @property {number[]} param Two-element array containing the\n *  counts of input fields and additional parameters.\n */\n\nconst rank = {\n  create() {\n    let rank;\n    return {\n      init: () => rank = 1,\n      value: w => {\n        const i = w.index;\n        return (i && !w.peer(i)) ? (rank = i + 1) : rank;\n      }\n    };\n  },\n  param: []\n};\n\nconst cume_dist = {\n  create() {\n    let cume;\n    return {\n      init: () => cume = 0,\n      value: w => {\n        const { index, peer, size } = w;\n        let i = index;\n        if (cume < i) {\n          while (i + 1 < size && peer(i + 1)) ++i;\n          cume = i;\n        }\n        return (1 + cume) / size;\n      }\n    };\n  },\n  param: []\n};\n\n/**\n * Window operator definitions.\n */\nexport default {\n  /** @type {WindowDef} */\n  row_number: {\n    create() {\n      return {\n        init: noop,\n        value: w => w.index + 1\n      };\n    },\n    param: []\n  },\n\n  /** @type {WindowDef} */\n  rank,\n\n  /** @type {WindowDef} */\n  avg_rank: {\n    create() {\n      let j, rank;\n      return {\n        init: () => (j = -1, rank = 1),\n        value: w => {\n          const i = w.index;\n          if (i >= j) {\n            for (rank = j = i + 1; w.peer(j); rank += ++j);\n            rank /= (j - i);\n          }\n          return rank;\n        }\n      };\n    },\n    param: []\n  },\n\n  /** @type {WindowDef} */\n  dense_rank: {\n    create() {\n      let drank;\n      return {\n        init: () => drank = 1,\n        value: w => {\n          const i = w.index;\n          return (i && !w.peer(i)) ? ++drank : drank;\n        }\n      };\n    },\n    param: []\n  },\n\n  /** @type {WindowDef} */\n  percent_rank: {\n    create() {\n      const { init, value } = rank.create();\n      return {\n        init,\n        value: w => (value(w) - 1) / (w.size - 1)\n      };\n    },\n    param: []\n  },\n\n  /** @type {WindowDef} */\n  cume_dist,\n\n  /** @type {WindowDef} */\n  ntile: {\n    create(num) {\n      num = +num;\n      if (!(num > 0)) error('ntile num must be greater than zero.');\n      const { init, value } = cume_dist.create();\n      return {\n        init,\n        value: w => Math.ceil(num * value(w))\n      };\n    },\n    param: [0, 1]\n  },\n\n  /** @type {WindowDef} */\n  lag: {\n    create(offset, defaultValue = NULL) {\n      offset = +offset || 1;\n      return {\n        init: noop,\n        value: (w, f) => {\n          const i = w.index - offset;\n          return i >= 0 ? w.value(i, f) : defaultValue;\n        }\n      };\n    },\n    param: [1, 2]\n  },\n\n  /** @type {WindowDef} */\n  lead: {\n    create(offset, defaultValue = NULL) {\n      offset = +offset || 1;\n      return {\n        init: noop,\n        value: (w, f) => {\n          const i = w.index + offset;\n          return i < w.size ? w.value(i, f) : defaultValue;\n        }\n      };\n    },\n    param: [1, 2]\n  },\n\n  /** @type {WindowDef} */\n  first_value: {\n    create() {\n      return {\n        init: noop,\n        value: (w, f) => w.value(w.i0, f)\n      };\n    },\n    param: [1]\n  },\n\n  /** @type {WindowDef} */\n  last_value: {\n    create() {\n      return {\n        init: noop,\n        value: (w, f) => w.value(w.i1 - 1, f)\n      };\n    },\n    param: [1]\n  },\n\n  /** @type {WindowDef} */\n  nth_value: {\n    create(nth) {\n      nth = +nth;\n      if (!(nth > 0)) error('nth_value nth must be greater than zero.');\n      return {\n        init: noop,\n        value: (w, f) => {\n          const i = w.i0 + (nth - 1);\n          return i < w.i1 ? w.value(i, f) : NULL;\n        }\n      };\n    },\n    param: [1, 1]\n  },\n\n  /** @type {WindowDef} */\n  fill_down: {\n    create(defaultValue = NULL) {\n      let value;\n      return {\n        init: () => value = defaultValue,\n        value: (w, f) => {\n          const v = w.value(w.index, f);\n          return isValid(v) ? (value = v) : value;\n        }\n      };\n    },\n    param: [1, 1]\n  },\n\n  /** @type {WindowDef} */\n  fill_up: {\n    create(defaultValue = NULL) {\n      let value, idx;\n      return {\n        init: () => (value = defaultValue, idx = -1),\n        value: (w, f) => w.index <= idx ? value\n          : (idx = find(w, f, w.index)) >= 0 ? (value = w.value(idx, f))\n          : (idx = w.size, value = defaultValue)\n      };\n    },\n    param: [1, 1]\n  }\n};\n\nfunction find(w, f, i) {\n  for (const n = w.size; i < n; ++i) {\n    if (isValid(w.value(i, f))) return i;\n  }\n  return -1;\n}\n"],"names":[],"mappings":"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","x_google_ignoreList":[0]}