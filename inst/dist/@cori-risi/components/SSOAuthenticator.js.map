{"version":3,"file":"SSOAuthenticator.js","sources":["../../../../lib/@cori-risi/components/SSOAuthenticator.tsx"],"sourcesContent":["import * as React from \"react\";\nimport {\n    CSSProperties,\n    ReactElement,\n    useContext,\n    useEffect,\n    useState\n} from \"react\";\nimport { Amplify } from \"aws-amplify\";\nimport { AuthTokens, AuthError, fetchAuthSession, signInWithRedirect } from 'aws-amplify/auth';\nimport { AmplifyContext } from \"../../cori.data.api\";\n\nimport '@aws-amplify/ui-react/styles.css';\nimport './styles/CustomAmplifyAuthenticator.css';\nimport './styles/images/loading.gif';\n\nimport coriLogo from './Full-Logo_CORI_Dark-Teal.svg';\n\ntype AWSCredentials = {\n    accessKeyId: string;\n    secretAccessKey: string;\n    sessionToken?: string;\n    expiration?: Date;\n};\n\ntype AuthSession = {\n    tokens?: AuthTokens;\n    credentials?: AWSCredentials;\n    identityId?: string;\n    userSub?: string;\n};\n\nlet signInAttemptCount_local = 0;\nlet hasAuthSession_local = false;\n\n/**\n * This is a generalization of the Single Sign-On authentication component developed for the\n * [Calix Impact Tool](https://calix-impact-tool.ruralinnovation.us/){target=_blank}\n *\n * This component is best placed in `main.js` as part of the initial React root component mounting code:\n *\n * ```ts\n * import { SSOAuthenticator } from \"@cori-risi/cori.data.api\";\n *\n * import '@aws-amplify/ui-react/styles.css';\n * import \"@cori-risi/cori.data.api/inst/dist/cori.data.api.css\";\n *\n * // ...\n *\n * const AppWithAuthenticator = withAuthenticator(App, {\n *     formFields: signInFormFields,\n *     hideSignUp: true,\n *     loginMechanisms: ['username']\n * });\n *\n * export function renderToDom(container: HTMLElement) {\n *   createRoot(container).render(<React.StrictMode>\n *\n *       <AmplifyContextProvider\n *           domain={import.meta.env.VITE_COGNITO_DOMAIN}\n *           region={import.meta.env.VITE_REGION}\n *           identityPoolId={import.meta.env.VITE_IDENTITY_POOL_ID}\n *           userPoolId={import.meta.env.VITE_USER_POOL_ID}\n *           userPoolClientId={import.meta.env.VITE_USER_POOL_CLIENT_ID} >\n *           {(!!window.location.port && window.location.port.toString() === \"5173\") ? (\n *               <App />\n *           ) : (\n *               <SSOAuthenticator\n *                   provider={\"IdentityProviderName\"}\n *                   title={\"App Title\"}>\n *                   <AppWithAuthenticator />\n *               </SSOAuthenticator>\n *           ) : (\n *              <App />\n *           )}\n *       </AmplifyContextProvider>\n *\n *   </React.StrictMode>);\n * }\n *\n * ```\n *\n *  @param props.provider - name of the Identity Provider configured in AWS Cognito > Social and custom providers > Federated identity provider sign-in\n *  @param props.title - name of the application (should be same as the value of the title element in index.html)\n *  @param props.description - (optional) description or instructions to be displayed on authentication component\n *  @param props.logo - (optional) imported svg file (see example) to be displayed on authentication component\n */\nexport default function SSOAuthenticator (props: { children?: ReactElement, provider?: string, title?: string, description?: string, logo?: string }) {\n\n    const amplifyContext = useContext(AmplifyContext);\n\n    const [ hasAuthSession, setAuthSession ] = useState(false);\n    const [ signInAttemptCount, setSignInAttemptCount ] = useState(0);\n    const [ visibility, setVisibility ] = useState<CSSProperties>(({ \"visibility\": \"hidden\" } as CSSProperties));\n\n    useEffect(() => {\n\n        setTimeout(async () => {\n\n            // form data-amplify-form=\"\" data-amplify-authenticator-signin=\"\" method=\"post\"\n            const amplifyAuthenticatorForm: HTMLFormElement | null = document.querySelector('form[data-amplify-form]');\n            if (amplifyAuthenticatorForm !== null) {\n\n                const brandingInformation = (document.getElementById(\"branding-info\") === null) ?\n                    document.createElement(\"div\") : document.getElementById(\"branding-info\");\n\n                brandingInformation!.id = \"branding-info\"\n                brandingInformation!.innerHTML = `            \n  <span class=\"cori-logo\"><img src=\"${(!!props.logo && props.logo !== null) ? props.logo : coriLogo}\"  alt=\"${props.title! + \" Logo\"}\"/></span>\n  <p></p>\n  <br />\n  <h4>${props.title!}</h4>\n`;\n\n                console.log(amplifyAuthenticatorForm);\n                (amplifyAuthenticatorForm).before(brandingInformation!);\n\n                const signInButton: HTMLButtonElement | null = amplifyAuthenticatorForm.querySelector('.amplify-button[type=\"submit\"]');\n\n                if (signInButton !== null && signInButton.innerHTML === \"Sign in\") {\n                    signInButton.innerHTML = `Continue to authenticate with ${props.provider}`;\n                    signInButton.onclick = async function () {\n                        console.log(\"Sign In attempts: \", signInAttemptCount);\n\n                        setSignInAttemptCount(1);\n\n                        if (props.hasOwnProperty(\"provider\") && props.provider!.length > 0) {\n\n                            const authResponse = await (signInWithRedirect({\n                                    provider: {\n                                        custom: props.provider!\n                                    }\n                                })\n                                    .catch((error) => {\n\n                                        if (error instanceof AuthError) {\n                                            console.log(error);\n\n                                            if (error.name === 'UserAlreadyAuthenticatedException') {\n                                                // do something...\n                                            }\n                                        }\n                                    })\n                            );\n\n                            console.log(\"Completed signInWithRedirect:\", authResponse);\n                        }\n                    };\n\n                    const amplifyFormFieldset: HTMLInputElement | null = amplifyAuthenticatorForm.querySelector('fieldset.amplify-flex');\n                    if (amplifyFormFieldset !== null) {\n                        amplifyFormFieldset.style.display = \"none\";\n                    }\n\n                    const privacyInformation = (document.getElementById(\"privacy-info\") === null) ?\n                        document.createElement(\"div\") :\n                        document.getElementById(\"privacy-info\");\n                    privacyInformation!.id = \"privacy-info\"\n                    privacyInformation!.innerHTML = `\n                    <p></p>\n                    <p>This Site uses cookies to offer you a better browsing experience and to analyze Site\n                        traffic. By continuing to access the Site, you consent to our use of cookies and storage and use of\n                        your data as provided in our <a href=\"http://ruralinnovation.us/privacy-policy/\" target=\"_blank\">Privacy Policy</a>.\n                    </p>\n                    <p></p>\n`;\n\n                    const footerLoader: HTMLDivElement | null = document.querySelector('[data-amplify-footer]');\n                    if (footerLoader !== null) {\n                        footerLoader.style.background = \"none\";\n                        // (footerLoader).after(privacyInformation!);\n                        (footerLoader).before(privacyInformation!);\n                    }\n                }\n            }\n\n            if (!!amplifyContext\n                && !!amplifyContext.domain\n                && !!amplifyContext.region\n                && !!amplifyContext.identityPoolId\n                && !!amplifyContext.userPoolId\n                && !!amplifyContext.userPoolClientId\n                && (!hasAuthSession && !hasAuthSession_local)\n            ) {\n\n                console.log(\"Amplify configured with: \", {\n                    ...Amplify.getConfig()\n                });\n\n                hasAuthSession_local = true;\n                signInAttemptCount_local = 1\n\n                setAuthSession(hasAuthSession_local);\n\n                if (window.location.search.match(\"code\") !== null) {\n\n                    if (window.location.search.match(\"error\") === null)\n                        await (fetchAuthSession!()\n                                .then((sess: AuthSession) => {\n\n                                    console.log(sess);\n\n                                    if (signInAttemptCount < 1) {\n                                        console.log(\"Previous sign-in attempts: \", signInAttemptCount);\n\n                                        setSignInAttemptCount(signInAttemptCount_local);\n\n                                        try {\n                                            if (!!sess && (sess as any).hasOwnProperty(\"tokens\") && (sess as any)[\"tokens\"].hasOwnProperty(\"idToken\")) {\n\n                                                console.log(\"API context is authenticated and ready\");\n\n                                            } else {\n\n                                                /* If we CANNOT fetch a valid token (idToken) then present user with button to initiating SSO signin */\n                                                setVisibility({\n                                                    \"visibility\": \"visible\"\n                                                });\n\n                                            }\n                                        } catch (e: any) {\n                                            console.log(e.message, sess)\n\n                                            setVisibility({\n                                                \"visibility\": \"visible\"\n                                            });\n                                        }\n                                    }\n                                })\n                                .catch((error) => {\n\n                                    setVisibility({\n                                        \"visibility\": \"visible\"\n                                    });\n\n                                    console.log(error);\n                                    // console.log(error.cause);\n                                    console.log(error.stack);\n                                    console.log(error.recoverySuggestion)\n\n                                    if (error.hasOwnProperty(\"code\")) {\n                                        console.log(\"Error code:\", error.code!);\n                                        // if (error.code! === \"ERR_BAD_REQUEST\"\n                                        //     || error.code! === \"ERR_NETWORK\"\n                                        // ) {\n                                        //     autoSignOut();\n                                        //\n                                        // } else if (error.code === 'ERR_NAME_NOT_RESOLVED') {\n                                        //     console.error('Invalid baseURL:', apiClient.defaults.baseURL);\n                                        //     // Handle invalid baseURL error\n                                        // }\n                                    } else {\n                                        console.log(error.toString());\n                                    }\n                                })\n                        );\n                } else if (window.location.search.match(\"error\") === null) {\n\n                    // ... if no URL query param \"code\", silently sign-in (refresh)\n                    await (signInWithRedirect({\n                            provider: {\n                                custom: props.provider!\n                            }\n                        })\n                            .catch((error) => {\n\n                                if (error instanceof AuthError) {\n                                    console.log(error);\n                                    // console.log(error.cause);\n                                    console.log(error.stack);\n                                    console.log(error.recoverySuggestion)\n\n                                    if (error.name === 'UserAlreadyAuthenticatedException') {\n                                        // do something...\n                                    }\n                                }\n                            })\n                    );\n\n                    setVisibility({\n                        \"visibility\": \"visible\"\n                    });\n\n                }\n\n            } else {\n                console.log(window.location.search);\n            }\n\n        }, 533);\n    }, [\n        amplifyContext\n    ]);\n\n    return (\n        <div className={\"app-with-authenticator\"} style={visibility}>\n            {props.children}\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}