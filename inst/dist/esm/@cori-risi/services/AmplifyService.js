/*
 * CORI Data API Package
 * {@link https://github.com/ruralinnovation/cori.data.api}
 * @copyright Rural Innovation Strategies, Inc.
 * @license ISC
 */
import{Logger as t,Amplify as e,Auth as r,Hub as n}from"aws-amplify";const i=new t("AmplifyService");class a{constructor(){}static configure(t,r){return"function"==typeof r?r(e.configure(t)):e.configure(t),t}static federatedLogin(t){return console.log(`Attempt federated login ${t?"with provider: "+t:""} ...`),i.info(`Attempt federated login ${t?"with provider: "+t:""} ...`),t?r.federatedSignIn({provider:t}):r.federatedSignIn()}static async getAccessJwtToken(){try{const t=await r.currentSession();return t.getAccessToken().getJwtToken()}catch(t){throw i.error("Cannot get JWT Token because Amplify is not currently authenticated: ",t),t}}static async getIdToken(){try{const t=await r.currentSession();return t.getIdToken().getJwtToken()}catch(t){throw i.error("Unable to get ID token",t),t}}static async getClaims(){try{const t=await r.currentSession(),e=t.getIdToken().decodePayload();return{username:e["cognito:username"],email:e.email,groups:e["cognito:groups"]?e["cognito:groups"]:[]}}catch(t){throw i.error("Cannot get claims because Amplify is not currently authenticated: ",t),t}}static async getCredentials(){try{const t=await r.currentUserCredentials();return r.essentialCredentials(t)}catch(t){throw i.error("Error retrieving credentials: ",t),t}}static async getUserId(t){let e=null;try{const n=await r.currentAuthenticatedUser();"function"==typeof t&&t(n),e=n.hasOwnProperty("identities")&&n.identities.length>0?n.identities[0].userId:n.email}catch(t){i.error("Amplify is not currently authenticated: ",t)}return e}static async isAuthenticated(t){try{const e=await r.currentAuthenticatedUser();return"function"==typeof t&&t(e),!0}catch(t){return i.error("Amplify is not currently authenticated: ",t),!1}}static async setHubListener(t){i.info("Set Hub listener called with current updateAuthUser:",JSON.stringify(t));try{n.listen("auth",(e=>{let{payload:{event:r,data:n}}=e;if(i.info("Call Hub listener called with event:",r),"signIn"===r)this.getClaims().then((e=>{e?t({username:e.username,userType:"user",groups:e.groups,email:e.email}):this.isAuthenticated()?i.info("No authenticated claims found"):i.info("Amplify is not currently authenticated")})).catch((t=>{i.error("Cannot get claims because Amplify is not currently authenticated: ",t)}));else i.info("Sign out")}))}catch(t){i.error("Cannot get claims: ",t)}}}export{a as default};
