{"version":3,"file":"cori.data.api7.js","sources":["../../lib/@cori-risi/components/LineChart.tsx"],"sourcesContent":["import React, {useCallback, useContext, useEffect, useState} from 'react';\nimport * as d3 from 'd3';\nimport * as d3textwrap from \"d3-textwrap\";\n\nimport CDAContextWrapper, { CDAContext } from \"../contexts/CDAContextWrapper\";\nimport CategoricalLegend from './CategoricalLegend';\n\nimport { ERCData, MetricMetadata } from '../interfaces';\nimport { applyCORIStyles, getMaxYLabelWidth, saveChartAsPNG, getGEOIDColorRange } from '../utils';\nimport { chartStyle } from '../utils/constants';\n\nimport styles from \"./styles/Chart.module.css\";\n\ninterface LineChartProps {\n  primary_geoid: string,\n  metric: string,\n  data: ERCData[];\n  metadata: MetricMetadata,\n  width: number;\n  height: number;\n}\n\nfunction LineChart ({ primary_geoid, metric, data, metadata, width, height }: LineChartProps): JSX.Element {\n\n  const contextWrapper = useContext(CDAContext);\n\n  const primary_dta = data.filter(d => d.geoid === primary_geoid && d.metric === metric);\n  const has_valid_data = !primary_dta.every(d => d.value === null);\n\n  const [ colorScaleDomain, setColorScaleDomain ] = useState<string[]>([]);\n  const [ colorScaleRange, setColorScaleRange] = useState<unknown[]>([]);\n\n  console.log(\"Is React.useRef instantiated?\", {\n    \"React\": React,\n    \"useRef\": React.useRef\n  });\n\n  let ref: React.MutableRefObject<HTMLDivElement | null> | null = null;  // contextWrapper.useRef<HTMLDivElement | null>(null);\n  let svgRef: React.MutableRefObject<SVGSVGElement | null> | null = null;// contextWrapper.useRef<SVGSVGElement | null>(null);\n\n  useEffect(() => {\n\n    console.log(\"Is contextWrapper instantiated?\", {\n      \"contextWrapper\": contextWrapper,\n      \"useRef\": contextWrapper.useRef\n    });\n\n    if (typeof contextWrapper.useRef === \"function\") {\n      if (ref === null) ref = contextWrapper.useRef<HTMLDivElement>(null);\n      if (svgRef === null) svgRef = contextWrapper.useRef<SVGSVGElement>(null);\n    }\n\n    if (svgRef !== null) {\n      if (!svgRef.current) return;\n\n      const margin = {...chartStyle.margin};\n      const tick_number = Math.floor(width / 225);\n      const y_axis_tick_size = 8;\n\n      const svg = d3.select(svgRef.current)\n          .attr(\"viewBox\", `0 0 ${width} ${height}`)\n          .attr(\"preserveAspectRatio\", \"xMidYMid meet\");\n\n      const xScale = d3\n          .scaleLinear()\n          .domain([d3.min(data, (d) => (+d.year))!, d3.max(data, (d) => (+d.year))! ])\n          .nice()\n          .range([margin.left, width - margin.right]);\n\n      const yScale = d3\n          .scaleLinear()\n          .domain([\n            d3.max(data, (d) => d.value === null? undefined: (+d.value))!,\n            d3.min(data, (d) => d.value === null? undefined: (+d.value))!\n          ])\n          .nice()\n          .range([margin.top, height - margin.bottom]);\n\n      const max_year: number = d3.max(data, (d) => +d.year) as number;\n      const sortedGEOIDs = [...data]\n          .filter(d => +d.year === max_year)\n          .sort((a, b) => { // b.value - a.value\n            if (a.value === null && b.value === null) return 0;\n            if (a.value === null) return 1; // Treat null values as greater (will move to end)\n            if (b.value === null) return -1; // Treat null values as greater (will move to end)\n            return +b.value - +a.value;\n          });\n\n      const geoid_domain = [...new Set(sortedGEOIDs.map(d => d.geoid.toString()))];\n      const colorScale = d3.scaleOrdinal()\n          .domain(geoid_domain)\n          .range(geoid_domain.map(getGEOIDColorRange));\n\n      setColorScaleDomain(colorScale.domain());\n      setColorScaleRange(colorScale.range());\n\n      let xAxis = d3.axisBottom<number>(xScale); // later is reassigned\n      const yAxis = d3.axisLeft<number>(yScale)\n          .ticks(tick_number, metadata.yFormat)\n          .tickSize(y_axis_tick_size);\n\n      svg\n          .select<SVGGElement>('.x-axis')\n          .attr('transform', `translate(0, ${height - margin.bottom})`)\n          .call(xAxis);\n\n      svg.select<SVGGElement>('.y-axis')\n          .attr(\"transform\", `translate(${margin.left},0)`)\n          .call(yAxis)\n          .call(g => g.select(\".domain\").remove());\n\n      // style y-axis text before calculating widths\n      svg.selectAll(\".y-axis text\")\n          .style(\"font-family\", chartStyle.tickFontFamily)\n          .style(\"font-size\", chartStyle.tickFontSize)\n          .style(\"color\", chartStyle.tickFontColor)\n\n      const maxw = getMaxYLabelWidth(svg);\n\n      // If we need to wrap labels\n      if (maxw > 200) {\n\n        // wrap the text\n        const textwrap_dimensions = {height: 20, width: 200};\n        const y_wrap = d3textwrap.textwrap().bounds(textwrap_dimensions);\n        svg.selectAll(\".y-axis text\")\n            .call(y_wrap)\n            .call(g => g.selectAll('foreignObject')\n                .style(\"transform\", 'translate(-' + textwrap_dimensions.width + 'px, -' + .5 + 'rem)')\n            );\n\n        xScale.range([margin.left, width - margin.right]);\n        xAxis = d3\n            .axisBottom<number>(xScale)\n            .tickSize(chartStyle.xTickSize)\n            .ticks(tick_number, metadata.xFormat);\n\n        svg\n            .select<SVGGElement>('.x-axis')\n            .attr('transform', `translate(0, ${height - margin.bottom})`)\n            .call(xAxis);\n\n        svg.select<SVGGElement>('.y-axis')\n            .attr(\"transform\", `translate(${margin.left},0)`);\n\n      }\n      else {\n\n        margin.left = maxw + y_axis_tick_size;\n\n        xScale.range([margin.left, width - margin.right]);\n        xAxis = d3\n            .axisBottom<number>(xScale)\n            .tickSize(12)\n            .ticks(tick_number, metadata.xFormat);\n\n        svg\n            .select<SVGGElement>('.x-axis')\n            .attr('transform', `translate(0, ${height - margin.bottom})`)\n            .call(xAxis);\n\n        svg.select<SVGGElement>('.y-axis')\n            .attr(\"transform\", `translate(${margin.left},0)`);\n\n      }\n\n      // Group data by geoid\n      const sortedData = [...data].sort((a, b) => a.year - b.year);\n      const nestedData = d3.group(sortedData, d => d.geoid);\n\n      // Define line generator\n      const line = d3.line<ERCData>()\n          .defined(d => d.value !== null)\n          .x(d => xScale(+d.year))\n          .y(d => yScale(+d.value!));\n\n      // Add gridlines\n      const GridLine = () => d3.axisLeft(yScale);\n      svg.selectAll(\".grid\").remove();\n      svg\n          .append(\"g\")\n          .attr(\"class\", \"grid\")\n          .call(GridLine().ticks(tick_number))\n          .call(g => g.select(\".domain\").remove())\n          .call(g => g.selectAll(\".tick line\")\n              .attr(\"x1\", margin.left)\n              .attr(\"x2\", width - margin.right)\n          );\n\n      svg.selectAll(\".data-lines\").remove();\n      nestedData.forEach((d) => {\n        svg\n            .append(\"path\")\n            .attr(\"class\", \"data-lines\")\n            .datum(d)\n            .attr(\"fill\", \"none\")\n            .attr(\"stroke\", function(d) {\n              const line_color: string | unknown = colorScale(d[0].geoid);\n              if (typeof line_color === \"string\")\n                return line_color;\n\n              return \"black\";\n            })\n            .attr(\"stroke-width\", chartStyle.strokeWidth)\n            .attr(\"stroke-opacity\", chartStyle.strokeOpacity)\n            .attr(\"d\", line);\n      });\n\n      // nestedData.forEach((d) => {\n      //   svg\n      //   .append(\"g\")\n      //   .selectAll(\"dot\")\n      //   .data(d)\n      //   .enter()\n      //   .append(\"circle\")\n      //     .attr(\"cx\", function(d) { return xScale(+d.year) } )\n      //     .attr(\"cy\", function(d) { return yScale(+d.value) } )\n      //     .attr(\"r\", 5)\n      //     .attr(\"fill\", \"#69b3a2\")\n      // });\n\n      svg.call(applyCORIStyles);\n    }\n\n  }, [data, width, height, metadata]);\n\n  const onButtonClick = useCallback(() => {\n    if (ref !== null) {\n      saveChartAsPNG(ref, metric + \".png\");\n    }\n  }, [metric]);\n\n  return (\n      <div className={styles[\"chart-wrapper\"]}>\n        {data.length > 0 && (\n            <>\n              <div ref={ref} className={styles[\"chart\"]} style={{maxWidth: \"900px\", margin: \"0 auto\", padding: \"5px 20px\"}}>\n                {\n                    has_valid_data === false && (\n                        <div className={styles[\"no-data\"]}>\n                          <p>Note: Chart data is not available for the selected primary county</p>\n                        </div>\n                    )\n                }\n                <h3>{metadata.title}</h3>\n                {metadata.subtitle.length > 0? <p><em>{metadata.subtitle}</em></p>: <></>}\n                <CategoricalLegend domain_names={colorScaleDomain.map(c => data.filter(d => d.geoid === c).map(d => d.name)[0])} domain={colorScaleDomain} range={colorScaleRange} />\n                <svg ref={svgRef} style={{width: \"100%\"}}>\n                  <g className=\"x-axis\" />\n                  <g className=\"y-axis\" />\n                </svg>\n                <p className={styles['caption']}>{metadata[\"caption\"]}</p>\n              </div>\n              <button className={styles[\"download-chart\"]} onClick={onButtonClick}>Download image</button>\n            </>\n        )\n        }\n      </div>\n  );\n};\n\nexport default (props: LineChartProps) => (\n    <CDAContextWrapper>\n      <LineChart {...props} />\n    </CDAContextWrapper>\n);\n\n// export default LineChart;\n// export default wrapComponent(LineChart);"],"names":["LineChart","primary_geoid","metric","data","metadata","width","height","contextWrapper","useContext","CDAContext","has_valid_data","d","colorScaleDomain","setColorScaleDomain","useState","colorScaleRange","setColorScaleRange","React","ref","svgRef","useEffect","margin","chartStyle","tick_number","y_axis_tick_size","svg","d3.select","xScale","d3.scaleLinear","d3.min","d3.max","yScale","max_year","sortedGEOIDs","a","b","geoid_domain","colorScale","d3.scaleOrdinal","getGEOIDColorRange","xAxis","d3.axisBottom","yAxis","d3.axisLeft","g","maxw","getMaxYLabelWidth","textwrap_dimensions","y_wrap","d3textwrap.textwrap","sortedData","nestedData","d3.group","line","d3.line","GridLine","line_color","applyCORIStyles","onButtonClick","useCallback","saveChartAsPNG","jsx","styles","jsxs","Fragment","CategoricalLegend","c","LineChart$1","props","CDAContextWrapper"],"mappings":"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"}