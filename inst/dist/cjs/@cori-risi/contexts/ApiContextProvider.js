/*
 * CORI Data API Package
 * {@link https://github.com/ruralinnovation/cori.data.api}
 * @copyright Rural Innovation Strategies, Inc.
 * @license ISC
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("@aws-amplify/ui-react"),o=require("../services/AmplifyService.js"),l=require("../components/CustomAmplifyAuthenticator.js"),n=require("query-string"),s=require("../utils/autoSignIn.js"),a=require("react/jsx-runtime");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=u(n);const r=e.createContext({authenticated_user:null});exports.ApiContext=r,exports.default=function(n){const[u,c]=e.useState(null),[d,f]=e.useState(null),[h,g]=e.useState({clientId:"",identityPoolId:"",userPoolId:"",domain:"",hostedAuthenticationUrl:"",logoutUrl:""}),[p,m]=e.useState(!1);e.useState(null);const[A,y]=e.useState(null),S=i.default.parse(location.search).geoid,I=i.default.parse(location.search).location,[_,v]=e.useState(location.pathname+""),[j,x]=e.useState(S),[O,P]=e.useState(I),[q,k]=e.useState({authenticated_user:u,token:A});return window.AmplifyService=o.default,e.useEffect((()=>{if(console.log("Init Amplify config:",d),null===d){const e=o.default.configure(n.aws_config,f),t={};for(const o in h)e.Auth.hasOwnProperty(o)&&(t[o]=e.Auth[o]);g(t)}else o.default.setHubListener(c).then((()=>{console.log("Passed setAuthenticatedUser to AmplifyService")})),o.default.isAuthenticated().then((e=>{console.log("Authenticated ",e),e?(console.log("Get Amplify claims..."),o.default.getClaims().then((e=>{const t=localStorage.getItem("redirect_after_auth");console.log(JSON.parse(t)),e?(c(null===u?{username:e.username,userType:"admin",groups:e.groups,email:e.email}:{...u,username:e.username,userType:"admin",groups:e.groups,email:e.email}),m(!0)):console.log("No claims found")})).catch((e=>{console.log(e),c(null)}))):c({username:"",userType:"",groups:[],email:""})})).catch((e=>{console.log("ERROR",e)}))}),[d]),e.useEffect((()=>{if(!p){if(console.log("Init Amplify cognito: ",h),h.clientId)return console.log("If not authenticated, save initial path to localStorage."),console.log("GEOID: ",j),console.log("LOCATION: ",O),console.log("PATH: ",_),localStorage.setItem("redirect_after_auth",{init_path:_,geoid:j,location_label:O}),s.default(),void m(!0);if(null!==d){const e={};for(const t in h)d.Auth.hasOwnProperty(t)&&(e[t]=d.Auth[t]);g(e),m(!0)}}}),[h]),e.useEffect((()=>{u&&null!==u&&null===A&&(console.log("Attempt to get access token"),k({authenticated_user:u,token:A}),o.default.getIdToken().then((e=>{console.log("token:",e),y(e)})).catch((e=>{console.log(e)})))}),[u]),e.useEffect((()=>{k({authenticated_user:u,token:A})}),[A]),a.jsx(t.AmplifyProvider,{children:a.jsx(r.Provider,{className:"controls",value:q,children:a.jsx(l.default,{authenticated_user:u,setAuthenticatedUser:c,children:p?n.children:a.jsx("span",{children:"LOADING"})})})})};
