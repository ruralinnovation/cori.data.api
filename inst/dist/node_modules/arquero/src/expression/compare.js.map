{"version":3,"file":"compare.js","sources":["../../../../../../node_modules/arquero/src/expression/compare.js"],"sourcesContent":["import codegen from './codegen';\nimport parse from './parse';\nimport { aggregate } from '../engine/reduce/util';\n\n// generate code to compare a single field\nconst _compare = (u, v, lt, gt) =>\n  `((u = ${u}) < (v = ${v}) || u == null) && v != null ? ${lt}\n    : (u > v || v == null) && u != null ? ${gt}\n    : ((v = v instanceof Date ? +v : v), (u = u instanceof Date ? +u : u)) !== u && v === v ? ${lt}\n    : v !== v && u === u ? ${gt} : `;\n\nexport default function(table, fields) {\n  // parse expressions, generate code for both a and b values\n  const names = [];\n  const exprs = [];\n  const fn = [];\n  let keys = null, opA = '0', opB = '0';\n  if (table.isGrouped()) {\n    keys = table.groups().keys;\n    opA = 'ka';\n    opB = 'kb';\n  }\n  const { ops } = parse(fields, {\n    table,\n    value: (name, node) => {\n      names.push(name);\n      if (node.escape) {\n        // if an escaped function, invoke it directly\n        const f = i => `fn[${fn.length}](${i}, data)`;\n        exprs.push([f('a'), f('b')]);\n        fn.push(node.escape);\n      } else {\n        // generate code to extract values to compare\n        exprs.push([\n          codegen(node, { index: 'a', op: opA }),\n          codegen(node, { index: 'b', op: opB })\n        ]);\n      }\n    },\n    window: false\n  });\n\n  // calculate aggregate values if needed\n  const result = aggregate(table, ops);\n  const op = (id, row) => result[id][row];\n\n  // generate comparison code for each field\n  const n = names.length;\n  let code = 'return (a, b) => {'\n    + (op && table.isGrouped() ? 'const ka = keys[a], kb = keys[b];' : '')\n    + 'let u, v; return ';\n  for (let i = 0; i < n; ++i) {\n    const o = fields.get(names[i]).desc ? -1 : 1;\n    const [u, v] = exprs[i];\n    code += _compare(u, v, -o, o);\n  }\n  code += '0;};';\n\n  // instantiate and return comparator function\n  return Function('op', 'keys', 'fn', 'data', code)(op, keys, fn, table.data());\n}"],"names":["parse"],"mappings":"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","x_google_ignoreList":[0]}