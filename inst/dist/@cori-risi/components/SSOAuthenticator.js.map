{"version":3,"file":"SSOAuthenticator.js","sources":["../../../../lib/@cori-risi/components/SSOAuthenticator.tsx"],"sourcesContent":["import * as React from \"react\";\nimport {\n    ReactElement,\n    useContext,\n    useEffect,\n    useState\n} from \"react\";\nimport { Amplify } from \"aws-amplify\";\nimport { AuthTokens, AuthError, fetchAuthSession, signInWithRedirect } from 'aws-amplify/auth';\nimport { AmplifyContext } from \"../../cori.data.api\";\n\nimport '@aws-amplify/ui-react/styles.css';\nimport './styles/CustomAmplifyAuthenticator.css';\nimport './styles/images/loading.gif';\n\ntype AWSCredentials = {\n    accessKeyId: string;\n    secretAccessKey: string;\n    sessionToken?: string;\n    expiration?: Date;\n};\n\ntype AuthSession = {\n    tokens?: AuthTokens;\n    credentials?: AWSCredentials;\n    identityId?: string;\n    userSub?: string;\n};\n\nlet signInAttemptCount_local = 0;\nlet hasAuthSession_local = false;\n\nexport default function SSOAuthenticator (props: { children?: ReactElement, provider?: string, title?: string, description?: string }) {\n\n    const amplifyContext = useContext(AmplifyContext);\n\n    const [ hasAuthSession, setAuthSession ] = useState(false);\n    const [ signInAttemptCount, setSignInAttemptCount ] = useState(0);\n\n    useEffect(() => {\n\n        setTimeout(async () => {\n\n            if (!!amplifyContext\n                && !!amplifyContext.domain\n                && !!amplifyContext.region\n                && !!amplifyContext.identityPoolId\n                && !!amplifyContext.userPoolId\n                && !!amplifyContext.userPoolClientId\n                && (!hasAuthSession && !hasAuthSession_local)\n            ) {\n\n                console.log(\"Amplify configured with: \", {\n                    ...Amplify.getConfig()\n                });\n\n                hasAuthSession_local = true;\n                signInAttemptCount_local = 1\n\n                setAuthSession(hasAuthSession_local);\n\n                await (fetchAuthSession!()\n                        .then((sess: AuthSession) => {\n\n                            console.log(sess);\n\n                            if (signInAttemptCount < 1) {\n                                console.log(\"Previous sign-in attempts: \", signInAttemptCount);\n\n                                setSignInAttemptCount(signInAttemptCount_local);\n\n                                if (!(sess === null && (sess as any).hasOwnProperty(\"tokens\") && (sess as any)[\"tokens\"].hasOwnProperty(\"idToken\"))) {\n\n                                    /* If we CANNOT fetch a valid token (idToken) then present user with button to initiating SSO signin */\n\n                                    // form data-amplify-form=\"\" data-amplify-authenticator-signin=\"\" method=\"post\"\n                                    const amplifyAuthenticatorForm: HTMLFormElement | null = document.querySelector('form[data-amplify-form]');\n                                    if (amplifyAuthenticatorForm !== null) {\n\n                                        const brandingInformation = (document.getElementById(\"branding-info\") === null) ?\n                                            document.createElement(\"div\") : document.getElementById(\"branding-info\");\n\n                                        brandingInformation!.id = \"branding-info\"\n                                        brandingInformation!.innerHTML = `            \n  <span class=\"cori-logo\"><img src=\"/Full-Logo_CORI_Dark-Teal.svg\" /></span>\n  <p></p>\n  <br />\n  <h4>${props.title!}</h4>` +\n                                        (props.hasOwnProperty(\"description\") && !!(props.description!) && props.description!.length > 0) ?\n  `<p>${props.description!}</p>\n` : `\n`;\n                                        console.log(amplifyAuthenticatorForm);\n                                        (amplifyAuthenticatorForm).before(brandingInformation!);\n\n                                        const signInButton: HTMLButtonElement | null = amplifyAuthenticatorForm.querySelector('.amplify-button[type=\"submit\"]');\n\n                                        if (signInButton !== null && signInButton.innerHTML === \"Sign in\") {\n                                            signInButton.innerHTML = `Continue to authenticate with ${props.provider}`;\n                                            signInButton.onclick = async function () {\n                                                console.log(\"Sign In attempts: \", signInAttemptCount);\n\n                                                setSignInAttemptCount(1);\n\n                                                if (props.hasOwnProperty(\"provider\") && props.provider!.length > 0) {\n\n                                                    const authResponse = await (signInWithRedirect({\n                                                            provider: {\n                                                                custom: props.provider!\n                                                            }\n                                                        })\n                                                            .catch((error) => {\n\n                                                                if (error instanceof AuthError) {\n                                                                    console.log(error);\n\n                                                                    if (error.name === 'UserAlreadyAuthenticatedException') {\n                                                                        // do something...\n                                                                    }\n                                                                }\n                                                            })\n                                                    );\n\n                                                    console.log(\"Completed signInWithRedirect:\", authResponse);\n                                                }\n                                            };\n\n                                            const amplifyFormFieldset: HTMLInputElement | null = amplifyAuthenticatorForm.querySelector('fieldset.amplify-flex');\n                                            if (amplifyFormFieldset !== null) {\n                                                amplifyFormFieldset.style.display = \"none\";\n                                            }\n\n                                            const privacyInformation = (document.getElementById(\"privacy-info\") === null) ?\n                                                document.createElement(\"div\") :\n                                                document.getElementById(\"privacy-info\");\n                                            privacyInformation!.id = \"privacy-info\"\n                                            privacyInformation!.innerHTML = `\n                    <p></p>\n                    <p>This Site uses cookies to offer you a better browsing experience and to analyze Site\n                        traffic. By continuing to access the Site, you consent to our use of cookies and storage and use of\n                        your data as provided in our <a href=\"http://ruralinnovation.us/privacy-policy/\" target=\"_blank\">Privacy Policy</a>.\n                    </p>\n                    <p></p>\n`;\n\n                                            const footerLoader: HTMLDivElement | null = document.querySelector('[data-amplify-footer]');\n                                            if (footerLoader !== null) {\n                                                footerLoader.style.background = \"none\";\n                                                // (footerLoader).after(privacyInformation!);\n                                                (footerLoader).before(privacyInformation!);\n                                            }\n                                        }\n                                    }\n                                }\n                            }\n                        })\n                        .catch((error) => {\n\n                            console.log(error);\n                            // console.log(error.cause);\n                            console.log(error.stack);\n                            console.log(error.recoverySuggestion)\n\n                            if (error.hasOwnProperty(\"code\")) {\n                                console.log(\"Error code:\", error.code!);\n                                // if (error.code! === \"ERR_BAD_REQUEST\"\n                                //     || error.code! === \"ERR_NETWORK\"\n                                // ) {\n                                //     autoSignOut();\n                                //\n                                // } else if (error.code === 'ERR_NAME_NOT_RESOLVED') {\n                                //     console.error('Invalid baseURL:', apiClient.defaults.baseURL);\n                                //     // Handle invalid baseURL error\n                                // }\n                            } else {\n                                console.log(error.toString());\n                            }\n                        })\n                );\n            }\n        }, 533);\n    }, [\n        amplifyContext\n    ]);\n\n    return (\n        <div className={\"app-with-authenticator\"}>\n            {props.children}\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}