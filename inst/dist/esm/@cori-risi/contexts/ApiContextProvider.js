/*
 * CORI Data API Package
 * {@link https://github.com/ruralinnovation/cori.data.api}
 * @copyright Rural Innovation Strategies, Inc.
 * @license ISC
 */
import{useState as e,useEffect as o,createContext as t}from"react";import{AmplifyProvider as n}from"@aws-amplify/ui-react";import l from"../services/AmplifyService.js";import i from"../components/CustomAmplifyAuthenticator.js";import s from"query-string";import r from"../utils/autoSignIn.js";import{jsx as a}from"react/jsx-runtime";const c=t({authenticated_user:null});function u(t){const[u,m]=e(null),[h,g]=e(null),[d,p]=e({clientId:"",identityPoolId:"",userPoolId:"",domain:"",hostedAuthenticationUrl:"",logoutUrl:""}),[f,A]=e(!1);e(null);const[y,I]=e(null),_=s.parse(location.search).geoid,v=s.parse(location.search).location,[O,S]=e(location.pathname+""),[P,k]=e(_),[w,T]=e(v),[N,j]=e({authenticated_user:u,token:y});return window.AmplifyService=l,o((()=>{if(console.log("Init Amplify config:",h),null===h){const e=l.configure(t.aws_config,g),o={};for(const t in d)e.Auth.hasOwnProperty(t)&&(o[t]=e.Auth[t]);p(o)}else l.setHubListener(m).then((()=>{console.log("Passed setAuthenticatedUser to AmplifyService")})),l.isAuthenticated().then((e=>{console.log("Authenticated ",e),e?(console.log("Get Amplify claims..."),l.getClaims().then((e=>{const o=localStorage.getItem("redirect_after_auth");console.log(JSON.parse(o)),e?(m(null===u?{username:e.username,userType:"admin",groups:e.groups,email:e.email}:{...u,username:e.username,userType:"admin",groups:e.groups,email:e.email}),A(!0)):console.log("No claims found")})).catch((e=>{console.log(e),m(null)}))):m({username:"",userType:"",groups:[],email:""})})).catch((e=>{console.log("ERROR",e)}))}),[h]),o((()=>{if(!f){if(console.log("Init Amplify cognito: ",d),d.clientId)return console.log("If not authenticated, save initial path to localStorage."),console.log("GEOID: ",P),console.log("LOCATION: ",w),console.log("PATH: ",O),localStorage.setItem("redirect_after_auth",{init_path:O,geoid:P,location_label:w}),r(),void A(!0);if(null!==h){const e={};for(const o in d)h.Auth.hasOwnProperty(o)&&(e[o]=h.Auth[o]);p(e),A(!0)}}}),[d]),o((()=>{u&&null!==u&&null===y&&(console.log("Attempt to get access token"),j({authenticated_user:u,token:y}),l.getIdToken().then((e=>{console.log("token:",e),I(e)})).catch((e=>{console.log(e)})))}),[u]),o((()=>{j({authenticated_user:u,token:y})}),[y]),a(n,{children:a(c.Provider,{className:"controls",value:N,children:a(i,{authenticated_user:u,setAuthenticatedUser:m,children:f?t.children:a("span",{children:"LOADING"})})})})}export{c as ApiContext,u as default};
